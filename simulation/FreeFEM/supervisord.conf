# -*- coding: gb2312 -*-
# Supervisor配置文件

[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
loglevel=info

# FastAPI应用
[program:fastapi]
command=uvicorn main_api:app --host 0.0.0.0 --port 8000 --workers 4 --loop uvloop
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/fastapi-stdout.log
stderr_logfile=/var/log/supervisor/fastapi-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=PYTHONPATH="/app",LANG="zh_CN.GB2312",LC_ALL="zh_CN.GB2312"
user=root
killasgroup=true
stopasgroup=true

# ParaviewWeb服务器
[program:paraviewweb]
command=python paraviewweb_server.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/paraviewweb-stdout.log
stderr_logfile=/var/log/supervisor/paraviewweb-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
environment=PYTHONPATH="/app",DISPLAY=":99",LANG="zh_CN.GB2312",LC_ALL="zh_CN.GB2312"
user=root

# Nginx
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nginx-stdout.log
stderr_logfile=/var/log/supervisor/nginx-stderr.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile_backups=5
user=root

# X虚拟帧缓冲（用于ParaView）
[program:xvfb]
command=/usr/bin/Xvfb :99 -screen 0 1024x768x24 -ac +extension GLX +render -noreset
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/xvfb-stdout.log
stderr_logfile=/var/log/supervisor/xvfb-stderr.log
stdout_logfile_maxbytes=1MB
stderr_logfile_maxbytes=1MB
user=root

# 定期清理任务
[program:cleanup]
command=python /app/scripts/cleanup.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/cleanup-stdout.log
stderr_logfile=/var/log/supervisor/cleanup-stderr.log
stdout_logfile_maxbytes=1MB
stderr_logfile_maxbytes=1MB
environment=PYTHONPATH="/app",LANG="zh_CN.GB2312",LC_ALL="zh_CN.GB2312"
user=root

# 监控导出器（Prometheus）
[program:metrics]
command=python /app/scripts/metrics_exporter.py
directory=/app
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/metrics-stdout.log
stderr_logfile=/var/log/supervisor/metrics-stderr.log
stdout_logfile_maxbytes=1MB
stderr_logfile_maxbytes=1MB
environment=PYTHONPATH="/app",LANG="zh_CN.GB2312",LC_ALL="zh_CN.GB2312"
user=root

# 进程组管理
[group:freefem]
programs=fastapi,paraviewweb,nginx,xvfb
priority=999

[group:maintenance]
programs=cleanup,metrics
priority=100

# Unix socket设置
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

# RPC接口
[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# 客户端配置
[supervisorctl]
serverurl=unix:///var/run/supervisor.sock